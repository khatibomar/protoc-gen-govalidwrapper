# protoc-gen-govalidwrapper

A protoc plugin that generates Go validation wrapper structs and methods using [govalid](https://github.com/sivchari/govalid).

## Features

- Generate wrapper structs with govalid validation tags
- Automatically run govalid to generate validation functions
- Create validation methods on protobuf messages
- Clean protobuf option-based validation rules
- Works with protobuf's OPAQUE API for better encapsulation

## Installation

```bash
go install github.com/khatibomar/protoc-gen-govalidwrapper@latest
```

Make sure you also have `govalid` installed:

```bash
go install github.com/sivchari/govalid@latest
```

## Quick Start

1. Copy the `govalid.proto` file to your project
2. Import it in your proto files and add validation rules
3. Generate code with protoc

See the [example](./example/) directory for a complete working example.

## Usage

### Using in External Projects

1. **Install the plugin:**
```bash
go install github.com/khatibomar/protoc-gen-govalidwrapper@latest
```

2. **Copy the proto options file to your project:**
```bash
mkdir -p proto
curl -o govalid.proto https://raw.githubusercontent.com/khatibomar/protoc-gen-govalidwrapper/main/example/govalid.proto
```

3. **Use protobuf field options in your proto files:**
```protobuf
syntax = "proto3";

package user.v1;

import "govalid.proto";

option go_package = ".;userv1";

message CreateUserRequest {
  string name = 1 [(govalid.v1.govalid) = {rules: ["required"]}];
  string email = 2 [(govalid.v1.govalid) = {rules: ["email"]}];
  string password = 3;
  int32 age = 4 [(govalid.v1.govalid) = {rules: ["gte=18"]}];
  int32 retirement_age = 5;
}
```

## Code Generation

Run protoc with the plugin:

```bash
# Create output directories
mkdir -p gen/go

# Generate code (only specify your proto files, not govalid.proto)
protoc \
  --go_out=paths=source_relative,default_api_level=API_OPAQUE:gen/go \
  --go_opt=Mgovalid.proto=google.golang.org/protobuf/types/known/emptypb \
  --govalidwrapper_out=gen/go \
  --govalidwrapper_opt=Mgovalid.proto=google.golang.org/protobuf/types/known/emptypb \
  --plugin=protoc-gen-govalidwrapper=$(which protoc-gen-govalidwrapper) \
  -I. \
  -Iproto \
  user.proto
```

## Generated Code

The plugin generates:

1. **Wrapper struct** with govalid validation tags
2. **Validation functions** (generated by govalid)
3. **Validation methods** on the original protobuf message

### Example Output

```go
// Generated wrapper struct
type createUserRequestWrapper struct {
	// +govalid:required
	Name string
	// +govalid:email
	Email string
	Password string
	// +govalid:gte=18
	Age int32
	RetirementAge int32
}

// Generated by govalid
func ValidatecreateUserRequestWrapper(wrapper *createUserRequestWrapper) error {
	// ... validation logic
}

// Generated validation method
func (r *CreateUserRequest) Validate() error {
	return ValidatecreateUserRequestWrapper(&createUserRequestWrapper{
		Name:          r.GetName(),
		Email:         r.GetEmail(),
		Password:      r.GetPassword(),
		Age:           r.GetAge(),
		RetirementAge: r.GetRetirementAge(),
	})
}
```

## Usage in Code

```go
package main

import (
	"fmt"
	"log"
	userv1 "path/to/your/generated/code"
)

func main() {
	req := &userv1.CreateUserRequest{}
	req.SetName("John Doe")
	req.SetEmail("john@example.com")
	req.SetPassword("secret123")
	req.SetAge(25)
	req.SetRetirementAge(65)

	if err := req.Validate(); err != nil {
		log.Fatal("Validation failed:", err)
	}

	fmt.Println("Validation passed!")
}
```

## Supported govalid Rules

The plugin supports all govalid validation rules:

- `required` - Field must not be empty
- `email` - Field must be a valid email
- `gte=N` - Field must be greater than or equal to N
- `lte=N` - Field must be less than or equal to N
- `min=N` - Field length must be at least N
- `max=N` - Field length must be at most N
- And many more...

See [govalid documentation](https://github.com/sivchari/govalid) for the complete list.

## Advanced Usage

### Multiple Validation Rules

You can specify multiple rules for a single field:

```protobuf
string username = 1 [(govalid.v1.govalid) = {rules: ["required", "min=3", "max=20"]}];
```

### Complex Validation Rules

```protobuf
string phone = 1 [(govalid.v1.govalid) = {rules: ["required", "regexp=^\\+?[1-9]\\d{1,14}$"]}];
```

## How It Works

1. **Parse protobuf files** and extract validation rules from comments or options
2. **Generate wrapper structs** with govalid validation tags
3. **Write to output directory** where protoc expects generated files
4. **Run govalid** to generate validation functions
5. **Include govalid output** in the final generated file
6. **Generate validation methods** that call the govalid functions

## Project Structure

```
your-project/
├── govalid.proto                 # Copy this from plugin repo (for options only)
├── user.proto                    # Your proto files with govalid options
├── gen/
│   └── go/
│       ├── user.pb.go            # Generated by protoc-gen-go
│       └── user_govalid.pb.go    # Generated by protoc-gen-govalidwrapper
└── go.mod
```

## Important Notes

### govalid.proto is for Options Only

The `govalid.proto` file is only needed to define the field options that the plugin understands. **No Go code is generated from it** - it's purely for the protobuf option definitions.

- ✅ Copy `govalid.proto` to your project
- ✅ Import it in your proto files to use the options
- ✅ Only run protoc on your actual proto files (not govalid.proto)
- ✅ Use `M` option to prevent import issues
- ❌ Don't generate Go code from govalid.proto

The plugin automatically skips generating Go code for any `govalid.proto` files.

### Why API_OPAQUE?

This plugin is specifically designed to work with protobuf's `API_OPAQUE` mode, which provides better encapsulation by:

- **Hiding internal fields** - Direct field access is not allowed
- **Forcing getter methods** - All field access goes through `Get*()` methods
- **Better API design** - Cleaner separation between internal representation and public API

The generated validation code uses `r.GetName()`, `r.GetEmail()`, etc., which works perfectly with OPAQUE API requirements.

### Avoiding Import Issues

Since your proto files import `govalid.proto`, `protoc-gen-go` will try to generate an import statement for it. To prevent this from causing module issues, use the `M` option to map the proto file to an existing package:

```bash
--go_opt=Mgovalid.proto=google.golang.org/protobuf/types/known/emptypb
--govalidwrapper_opt=Mgovalid.proto=google.golang.org/protobuf/types/known/emptypb
```

This tells both plugins to import `emptypb` instead of trying to generate/import code from `govalid.proto`.

## Example

Check out the [example](./example/) directory for a complete working example that demonstrates:
- How to structure your proto files with govalid options
- How to run the code generation
- How to use the generated validation methods

## Requirements

- Go 1.18 or later
- protoc compiler
- govalid tool installed and in PATH
- protoc-gen-go plugin

## License

This project is licensed under the Apache License, Version 2.0.
