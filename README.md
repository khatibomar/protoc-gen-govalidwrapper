# protoc-gen-govalidwrapper

A protoc plugin that generates Go validation wrapper structs and methods using [govalid](https://github.com/sivchari/govalid).

## Features

- Generate wrapper structs with govalid validation markers
- Automatically run govalid to generate validation functions
- Create `Validate()` methods on protobuf messages
- Clean protobuf option-based validation rules
- Works with protobuf's `source_relative` paths and `API_OPAQUE` mode
- Proper package structure with separate validator files

## Installation

```bash
go install github.com/khatibomar/protoc-gen-govalidwrapper@latest
```

Make sure you also have `govalid` installed:

```bash
go install github.com/sivchari/govalid@latest
```

## Quick Start

1. Set up the govalid proto options in your project
2. Add validation rules to your proto files
3. Generate code with protoc

## Usage

### 1. Set up govalid.proto

Create the directory structure and copy the govalid proto file:

```bash
mkdir -p proto/govalid
```

Copy `proto/govalid/govalid.proto` from this repository to your project at `proto/govalid/govalid.proto`.
and update the `go_package` option to match your project's package structure.
example:
```proto
option go_package = "github.com/khatibomar/project_name/gen/go/govalid/v1;govalid_v1";
```

### 2. Create your proto files with validation rules

```protobuf
syntax = "proto3";

package greet.v1;

option go_package = "github.com/yourorg/yourproject/gen/go/greet/v1";

import "govalid/v1/govalid.proto";

service GreetService {
  rpc SayHello(SayHelloRequest) returns (SayHelloResponse);
}

message SayHelloRequest {
  string name = 1 [(govalid.v1.govalid) = {
    rules: ["required", "min_len:1", "max_len:50"]
  }];
  string email = 2 [(govalid.v1.govalid) = {
    rules: ["email"]
  }];
}

message SayHelloResponse {
  string message = 1;
}
```

### 3. Generate code

```bash
# Create output directories
mkdir -p gen/go

# Generate code for your proto files
protoc \
    --proto_path=proto \
    --go_out=paths=source_relative,default_api_level=API_OPAQUE:gen/go \
    --govalidwrapper_out=source_relative:gen/go \
    $proto
```

## Generated Code Structure

The plugin generates the following file structure:

```
gen/
└── go/
    ├── govalid/
    │   └── v1/
    │       └── govalid.pb.go                    # govalid proto definitions
    └── greet/
        └── v1/
            ├── greet.pb.go                  # regular protobuf file
            ├── greet_govalid.pb.go          # wrapper structs + validation methods
            └── greet_govalid.pb_*_validator.go  # govalid-generated validation functions
```

## Generated Code Example

The plugin generates three types of code:

### 1. Wrapper Structs (in `greet_govalid.pb.go`)

```go
// Code generated by protoc-gen-govalidwrapper. DO NOT EDIT.
package v1

type sayHelloRequestWrapper struct {
	// +govalid:required
	// +govalid:min_len:1
	// +govalid:max_len:50
	Name string
	// +govalid:email
	Email string
}
```

### 2. Validation Functions (generated by govalid in separate files)

```go
// Code generated by govalid; DO NOT EDIT.
package v1

func ValidatesayHelloRequestWrapper(t *sayHelloRequestWrapper) error {
	if t == nil {
		return ErrNilsayHelloRequestWrapper
	}

	if t.Name == "" {
		return ErrRequiredValidation
	}

	if !validationhelper.IsValidEmail(t.Email) {
		return ErrEmailValidation
	}

	return nil
}
```

### 3. Validation Methods (in `greet_govalid.pb.go`)

```go
func (r *SayHelloRequest) Validate() error {
	return ValidatesayHelloRequestWrapper(&sayHelloRequestWrapper{
		Name:  r.GetName(),
		Email: r.GetEmail(),
	})
}
```

## Usage in Code

```go
package main

import (
	"fmt"
	"log"
	greetv1 "github.com/yourorg/yourproject/gen/go/greet/v1"
)

func main() {
	req := &greetv1.SayHelloRequest{}
	req.SetName("John Doe")
	req.SetEmail("john@example.com")

	if err := req.Validate(); err != nil {
		log.Fatal("Validation failed:", err)
	}

	fmt.Println("Validation passed!")
}
```

## How It Works

The plugin uses a clean temporary directory approach:

1. **Parse protobuf files** and extract validation rules from field options
2. **Generate wrapper structs** with govalid validation markers in a temporary directory
3. **Create minimal go.mod** in temp directory for govalid execution
4. **Run govalid** in temp directory to generate validation functions
5. **Copy validator files** back to the correct package directory
6. **Generate validation methods** that call the govalid functions
7. **Clean up** temporary directory

This approach ensures:
- ✅ No duplicate functions
- ✅ Clean separation of concerns
- ✅ Proper package structure
- ✅ No chicken-and-egg problems

## Supported govalid Rules

The plugin supports all govalid validation rules. See [govalid documentation](https://github.com/sivchari/govalid) for the complete list of available rules:

- `required` - Field must be present
- `min_len:N` - Minimum string length
- `max_len:N` - Maximum string length
- `email` - Valid email format
- `regexp:PATTERN` - Regular expression match
- `gte:N` - Greater than or equal to
- `lte:N` - Less than or equal to
- And many more...

## Important Notes

### File Generation Rules

1. **Only messages with validation rules generate `Validate()` methods**
2. **The plugin skips `govalid.proto` files** - no wrapper code is generated for them
3. **Validator files are generated in the same package** as the proto files
4. **Uses `source_relative` paths** for proper directory structure

### Proto File Structure

Your proto files must be structured to match the desired output package structure:

```
proto/
├── govalid/
│   └── govalid.proto           # Validation options definitions
└── greet/
    └── v1/
        └── greet.proto         # Your service definitions
```

This generates:

```
gen/go/
├── govalid/
│   └── govalid.pb.go          # Generated in its own package
└── greet/
    └── v1/
        ├── greet.pb.go
        └── greet_govalid.pb.go # Generated in the same package
```

### Why API_OPAQUE?

This plugin is designed to work with protobuf's `API_OPAQUE` mode, which provides better encapsulation by:

- **Hiding internal fields** - Direct field access is not allowed
- **Forcing getter methods** - All field access goes through `Get*()` methods
- **Better API design** - Cleaner separation between internal representation and public API

The generated validation code uses `r.GetName()`, `r.GetEmail()`, etc., which works perfectly with OPAQUE API requirements.

### Multiple Validation Rules

You can specify multiple rules for a single field:

```protobuf
string username = 1 [(govalid.v1.govalid) = {
  rules: ["required", "min_len:3", "max_len:20"]
}];
```

**Note**: Currently, the plugin generates separate govalid markers for each rule. Future versions may optimize this based on govalid's multi-rule support.

## Requirements

- Go 1.21 or later
- protoc compiler
- govalid tool installed and in PATH
- protoc-gen-go plugin

## Troubleshooting

### govalid not found

Make sure govalid is installed and in your PATH:

```bash
go install github.com/sivchari/govalid@latest
which govalid
```

### Import issues

If you get import errors, make sure:
1. Your proto files are in the correct directory structure
2. The `go_package` option matches your intended package structure
3. You're using `source_relative` paths in the protoc command

### Validation methods not generated

Validation methods are only generated for messages that have fields with validation rules. If no fields have validation rules, no `Validate()` method is generated.

## License

This project is licensed under the Apache License, Version 2.0.
